<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headless FM Synth Controller</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding: 20px; }
        .control-group { margin: 20px auto; padding: 20px; border: 1px solid #444; border-radius: 10px; max-width: 400px; }
        .slider-container { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; }
        input[type=range] { width: 100%; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; border: none; color: white; border-radius: 5px; margin: 5px; }
        button:disabled { background: #555; }
        .status { margin-top: 10px; font-size: 0.9em; color: #aaa; }
    </style>
</head>
<body>

    <h1>ESP32 FM Synth</h1>

    <button id="connectBtn">Connect (Web MIDI)</button>
    <button id="connectBleBtn">Connect (Web Bluetooth)</button>
    <div class="status" id="statusText">Not Connected</div>

    <div class="control-group">
        <h2>Moog Filter</h2>
        <div class="slider-container">
            <label for="cutoff">Cutoff Frequency (CC 74)</label>
            <input type="range" id="cutoff" min="0" max="127" value="64">
        </div>
        <div class="slider-container">
            <label for="resonance">Resonance (CC 71)</label>
            <input type="range" id="resonance" min="0" max="127" value="0">
        </div>
    </div>

    <div class="control-group">
        <h2>FM Parameters</h2>
        <div class="slider-container">
            <label for="ratio">Ratio (CC 16)</label>
            <input type="range" id="ratio" min="0" max="127" value="64">
        </div>
        <div class="slider-container">
            <label for="index">Mod Index (CC 17)</label>
            <input type="range" id="index" min="0" max="127" value="64">
        </div>
        <div class="slider-container">
            <label for="attack">Attack (CC 18)</label>
            <input type="range" id="attack" min="0" max="127" value="20">
        </div>
        <div class="slider-container">
            <label for="decay">Decay (CC 19)</label>
            <input type="range" id="decay" min="0" max="127" value="64">
        </div>
        <div class="slider-container">
            <label for="sustain">Sustain (CC 20)</label>
            <input type="range" id="sustain" min="0" max="127" value="100">
        </div>
        <div class="slider-container">
            <label for="release">Release (CC 21)</label>
            <input type="range" id="release" min="0" max="127" value="40">
        </div>
    </div>

    <script>
        let midiAccess = null;
        let midiOutput = null;
        let bleDevice = null;
        let bleCharacteristic = null;

        const connectBtn = document.getElementById('connectBtn');
        const connectBleBtn = document.getElementById('connectBleBtn');
        const statusText = document.getElementById('statusText');

        // CC Mappings
        const CC_CUTOFF = 74;
        const CC_RESONANCE = 71;
        const CC_RATIO = 16;
        const CC_INDEX = 17;
        const CC_ATTACK = 18;
        const CC_DECAY = 19;
        const CC_SUSTAIN = 20;
        const CC_RELEASE = 21;

        // Web MIDI API Connection
        connectBtn.addEventListener('click', async () => {
            if (navigator.requestMIDIAccess) {
                try {
                    statusText.innerText = "Requesting MIDI Access...";
                    midiAccess = await navigator.requestMIDIAccess({ sysex: false });

                    midiAccess.onstatechange = (e) => {
                        console.log("MIDI State Change", e.port.name, e.port.connection, e.port.state);
                    };

                    const outputs = Array.from(midiAccess.outputs.values());
                    if (outputs.length === 0) {
                        statusText.innerText = "No MIDI outputs found. Pair device in OS settings first.";
                    } else {
                        midiOutput = outputs.find(o => o.name.includes("ESP32")) || outputs[0];
                        statusText.innerText = "Connected via Web MIDI to: " + midiOutput.name;
                        connectBtn.disabled = true;
                        connectBleBtn.disabled = true;
                    }
                } catch (err) {
                    statusText.innerText = "MIDI Access Failed: " + err;
                }
            } else {
                statusText.innerText = "Web MIDI API not supported.";
            }
        });

        // Web Bluetooth API Connection (Direct)
        connectBleBtn.addEventListener('click', async () => {
            if (navigator.bluetooth) {
                try {
                    statusText.innerText = "Requesting BLE Device...";
                    bleDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ name: 'ESP32_FM_Synth' }],
                        optionalServices: ['03b80e5a-ede8-4b33-a751-6ce34ec4c700'] // Standard MIDI Service UUID
                    });

                    statusText.innerText = "Connecting to GATT Server...";
                    const server = await bleDevice.gatt.connect();

                    statusText.innerText = "Getting MIDI Service...";
                    const service = await server.getPrimaryService('03b80e5a-ede8-4b33-a751-6ce34ec4c700');

                    statusText.innerText = "Getting MIDI Characteristic...";
                    bleCharacteristic = await service.getCharacteristic('7772e5db-3868-4112-a1a9-f2669d106bf3');

                    statusText.innerText = "Connected via Web Bluetooth!";
                    connectBtn.disabled = true;
                    connectBleBtn.disabled = true;

                } catch (err) {
                    statusText.innerText = "BLE Connection Failed: " + err;
                }
            } else {
                statusText.innerText = "Web Bluetooth API not supported.";
            }
        });

        function sendCC(cc, value) {
            // Send via Web MIDI
            if (midiOutput) {
                midiOutput.send([0xB0, cc, value]);
            }

            // Send via Web Bluetooth (Raw MIDI packet)
            if (bleCharacteristic) {
                // MIDI over BLE packet format: Header (timestamp high + status) + Timestamp Low + MIDI message
                // Header: 10xxxxxx (timestamp high) -> usually 0x80
                // Timestamp Low: 1xxxxxxx -> usually 0x80
                // Status: 0xB0 (CC)
                // Data1: cc
                // Data2: value

                // Simplified packet for BLE MIDI (legacy style might vary, but standard is complex)
                // Standard BLE MIDI Packet:
                // Byte 0: Header (1 bit = 1, 1 bit = timestamp high, 6 bits = timestamp high bits) -> 0x80
                // Byte 1: Timestamp Low (1 bit = 1, 7 bits = timestamp low) -> 0x80
                // Byte 2: Status (0xB0)
                // Byte 3: CC
                // Byte 4: Value

                let packet = new Uint8Array([0x80, 0x80, 0xB0, cc, value]);
                bleCharacteristic.writeValue(packet).catch(e => console.error(e));
            }
        }

        document.getElementById('cutoff').addEventListener('input', (e) => sendCC(CC_CUTOFF, e.target.value));
        document.getElementById('resonance').addEventListener('input', (e) => sendCC(CC_RESONANCE, e.target.value));
        document.getElementById('ratio').addEventListener('input', (e) => sendCC(CC_RATIO, e.target.value));
        document.getElementById('index').addEventListener('input', (e) => sendCC(CC_INDEX, e.target.value));
        document.getElementById('attack').addEventListener('input', (e) => sendCC(CC_ATTACK, e.target.value));
        document.getElementById('decay').addEventListener('input', (e) => sendCC(CC_DECAY, e.target.value));
        document.getElementById('sustain').addEventListener('input', (e) => sendCC(CC_SUSTAIN, e.target.value));
        document.getElementById('release').addEventListener('input', (e) => sendCC(CC_RELEASE, e.target.value));

    </script>
</body>
</html>
